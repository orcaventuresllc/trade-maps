<style>
    /* Container Styles */
    #insurance-map-container {
        max-width: 1160px;
        margin: 0 auto;
        padding: 20px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        color: #333;
    }
    
    /* Header Styles */
    .map-header {
        text-align: center;
        margin-bottom: 30px;
    }
    
    .map-header h2 {
        font-size: 28px;
        font-weight: 600;
        margin-bottom: 10px;
        color: #1a1a1a;
    }
    
    .map-subtitle {
        font-size: 16px;
        color: #666;
        margin: 0;
    }
    
    /* Toggle Button Styles */
    .metric-toggles {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }
    
    .metric-btn {
        padding: 10px 20px;
        border: 2px solid #ddd;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        color: #555;
    }
    
    .metric-btn:hover {
        background: #f5f5f5;
        border-color: #999;
    }
    
    .metric-btn.active {
        background: #2563eb;
        color: white;
        border-color: #2563eb;
    }
    
    /* WC Sub-buttons */
    .wc-sub-buttons {
        display: none;
        gap: 10px;
        justify-content: center;
        margin-top: -20px;
        margin-bottom: 20px;
    }
    
    .wc-sub-buttons.show {
        display: flex;
    }
    
    .wc-sub-btn {
        padding: 8px 16px;
        border: 2px solid #ddd;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.3s ease;
        color: #555;
    }
    
    .wc-sub-btn:hover {
        background: #f5f5f5;
        border-color: #999;
    }
    
    .wc-sub-btn.active {
        background: #10b981;
        color: white;
        border-color: #10b981;
    }
    
    /* Main content layout */
    .map-content-container {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    /* Map Wrapper */
    .map-wrapper {
        position: relative;
        background: #f9fafb;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        flex: 1;
    }
    
    #us-map-svg {
        width: 100%;
        height: auto;
        display: block;
    }
    
    #us-map-svg svg {
        width: 100%;
        height: auto;
        display: block;
    }
    
    /* State Styles */
    .state-path {
        stroke: #fff;
        stroke-width: 0.5;
        cursor: pointer;
        transition: all 0.2s ease;
        pointer-events: all !important;
        z-index: 10;
    }
    
    .state-path:hover {
        stroke: #333;
        stroke-width: 1.5;
        filter: brightness(0.9);
    }
    
    .state-path.selected {
        stroke: #f73333;
        stroke-width: 2;
        fill: #ffcccc !important;
    }
    
    /* Info Box Styles (replaces tooltip) */
    .info-box-hover {
        position: absolute;
        background: white;
        padding: 16px 20px;
        border-radius: 8px;
        min-width: 200px;
        pointer-events: none;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: 1px solid #e0e0e0;
    }
    
    .info-box-hover .state-name {
        font-size: 18px;
        font-weight: 600;
        color: #1a1a1a;
        margin: 0 0 8px 0;
    }
    
    .info-box-hover .metric-label {
        font-size: 12px;
        color: #666;
        margin: 0 0 4px 0;
    }
    
    .info-box-hover .metric-value {
        font-size: 24px;
        font-weight: 700;
        color: #2563eb;
        margin: 0;
    }
    
    /* Mobile Selector (hidden by default) */
    .mobile-selector {
        display: none;
        margin-bottom: 30px;
        text-align: center;
    }
    
    .mobile-selector label {
        display: block;
        margin-bottom: 10px;
        font-weight: 500;
        color: #555;
    }
    
    #state-dropdown {
        width: 100%;
        max-width: 300px;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        background: white;
        cursor: pointer;
    }
    
    /* Info Card */
    .info-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        width: 280px;
        flex-shrink: 0;
        align-self: flex-start;
    }
    
    .info-card-content {
        text-align: center;
    }
    
    .state-name {
        font-size: 20px;
        font-weight: 600;
        margin: 0 0 10px 0;
        color: #1a1a1a;
    }
    
    .metric-value {
        font-size: 28px;
        font-weight: 700;
        color: #2563eb;
        margin: 0 0 15px 0;
    }
    
    .metric-description {
        font-size: 14px;
        color: #666;
        line-height: 1.4;
        margin: 0 0 20px 0;
    }
    
    .cta-link {
        display: inline-block;
        background: #2563eb;
        color: white;
        padding: 10px 16px;
        border-radius: 6px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.2s ease;
    }
    
    .cta-link:hover {
        background: #1d4ed8;
        text-decoration: none;
        color: white;
    }
    
    /* Heatmap Colors */
    .heat-0 { fill: #F7F7F7; }
    .heat-1 { fill: #FDF4C4; }
    .heat-2 { fill: #FEE391; }
    .heat-3 { fill: #FEC44F; }
    .heat-4 { fill: #FE9929; }
    .heat-5 { fill: #EC7014; }
    .heat-6 { fill: #CC4C02; }
    .heat-7 { fill: #993404; }
    
    /* Legend */
    .legend {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 15px;
        gap: 8px;
        font-size: 12px;
        color: #666;
    }
    
    .legend-scale {
        display: flex;
        border-radius: 4px;
        overflow: hidden;
        border: 1px solid #ddd;
    }
    
    .legend-color {
        width: 20px;
        height: 16px;
    }
    
    .legend-color.heat-0 { background: #F7F7F7; }
    .legend-color.heat-1 { background: #FDF4C4; }
    .legend-color.heat-2 { background: #FEE391; }
    .legend-color.heat-3 { background: #FEC44F; }
    .legend-color.heat-4 { background: #FE9929; }
    .legend-color.heat-5 { background: #EC7014; }
    .legend-color.heat-6 { background: #CC4C02; }
    .legend-color.heat-7 { background: #993404; }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .map-content-container {
            flex-direction: column;
        }
        
        .info-card {
            width: 100%;
            order: -1;
        }
        
        .mobile-selector {
            display: block;
        }
        
        .state-path:hover {
            stroke: #fff;
            stroke-width: 0.5;
            filter: none;
        }
    }
    
    @media (max-width: 480px) {
        #insurance-map-container {
            padding: 15px;
        }
        
        .map-header h2 {
            font-size: 22px;
        }
        
        .metric-toggles {
            gap: 8px;
        }
        
        .metric-btn {
            padding: 8px 12px;
            font-size: 12px;
        }
    }
    
    /* Tooltip/Info Box Styles */
    #map-tooltip {
        position: absolute;
        background: white;
        padding: 12px 16px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: 1px solid #e0e0e0;
        pointer-events: none;
        z-index: 1000;
        display: none;
        min-width: 180px;
    }
    
    #map-tooltip .state-name {
        font-size: 16px;
        font-weight: 600;
        color: #1a1a1a;
        margin: 0 0 6px 0;
    }
    
    #map-tooltip .metric-label {
        font-size: 11px;
        color: #666;
        margin: 0 0 3px 0;
    }
    
    #map-tooltip .metric-value {
        font-size: 18px;
        font-weight: 700;
        color: #2563eb;
        margin: 0;
    }
</style>

<div id="insurance-map-container">
    <div class="map-header">
        <h2>Carpenter Insurance Cost Metrics by State</h2>
        <p class="map-subtitle">Explore insurance costs and savings opportunities across the United States</p>
    </div>
    
    <div class="metric-toggles">
        <button class="metric-btn active" data-metric="glPremiumPct">
            GL Premium % of Revenue
        </button>
        <button class="metric-btn" data-metric="glSavingsPct">
            GL Savings %
        </button>
        <button class="metric-btn" data-metric="glCompetitiveness">
            GL Carrier Competitiveness
        </button>
        <button class="metric-btn" data-metric="wcRate">
            WC Rate per $100
        </button>
    </div>
    
    <!-- WC Sub-buttons -->
    <div class="wc-sub-buttons" id="wc-sub-buttons">
        <button class="wc-sub-btn active" data-wc-code="5437">
            Class 5437 (Framing)
        </button>
        <button class="wc-sub-btn" data-wc-code="5645">
            Class 5645 (Interior)
        </button>
    </div>
    
    <div class="mobile-selector">
        <label for="state-dropdown">Select a State:</label>
        <select id="state-dropdown">
            <option value="">Choose a state...</option>
        </select>
    </div>
    
    <div class="map-content-container">
        <div class="map-wrapper">
            <div id="us-map-svg">
                <svg viewBox="0 0 1000 600" xmlns="http://www.w3.org/2000/svg">
                    <!-- Alaska -->
                    <path id="state-AK" class="state-path" fill="#ddd" d="M 158,458 L 177,471 L 200,464 L 213,481 L 208,500 L 223,515 L 245,510 L 268,525 L 271,540 L 285,546 L 294,535 L 320,548 L 338,540 L 350,520 L 362,530 L 375,522 L 388,532 L 403,525 L 418,532 L 430,520 L 445,525 L 460,515 L 475,520 L 488,510 L 500,520 L 515,512 L 528,520 L 540,510 L 555,515 L 568,505 L 580,512 L 595,505 L 608,512 L 620,500 L 635,505 L 648,495 L 660,502 L 675,495 L 688,502 L 700,490 L 715,495 L 728,485 L 740,492 L 755,485 L 768,492 L 780,480 L 795,485 L 808,475 L 820,482 L 835,475 L 848,482 L 860,470 L 875,475 L 888,465 L 900,472 L 915,465 L 928,472 L 940,460 L 955,465 L 968,455 L 980,462 L 995,455 L 1008,462 L 1020,450 L 1035,455 L 1048,445 L 1060,452 L 1075,445 L 1088,452 L 1100,440 L 1115,445 L 1128,435 L 1140,442 L 1155,435 L 1168,442 L 1180,430 L 1195,435 L 1208,425 L 1220,432 L 1235,425 L 1248,432 L 1260,420 L 1275,425 L 1288,415 L 1300,422"/>
                    
                    <!-- Hawaii -->
                    <circle id="state-HI" class="state-path" cx="250" cy="450" r="8" fill="#ddd"/>
                    <circle id="state-HI-2" class="state-path" cx="265" cy="445" r="6" fill="#ddd"/>
                    <circle id="state-HI-3" class="state-path" cx="280" cy="440" r="5" fill="#ddd"/>
                    <circle id="state-HI-4" class="state-path" cx="295" cy="435" r="4" fill="#ddd"/>
                    
                    <!-- Continental US States -->
                    <path id="state-WA" class="state-path" fill="#ddd" d="M 118,50 L 200,60 L 200,125 L 118,115 Z"/>
                    <path id="state-OR" class="state-path" fill="#ddd" d="M 118,115 L 200,125 L 195,185 L 118,175 Z"/>
                    <path id="state-CA" class="state-path" fill="#ddd" d="M 118,175 L 195,185 L 185,315 L 108,305 Z"/>
                    <path id="state-NV" class="state-path" fill="#ddd" d="M 195,185 L 235,190 L 230,270 L 185,315 L 195,185 Z"/>
                    <path id="state-ID" class="state-path" fill="#ddd" d="M 200,60 L 240,65 L 235,145 L 200,125 L 200,60 Z"/>
                    <path id="state-UT" class="state-path" fill="#ddd" d="M 235,145 L 275,150 L 270,210 L 235,190 L 235,145 Z"/>
                    <path id="state-AZ" class="state-path" fill="#ddd" d="M 230,270 L 275,275 L 270,315 L 185,315 L 230,270 Z"/>
                    <path id="state-MT" class="state-path" fill="#ddd" d="M 240,65 L 355,75 L 350,130 L 235,145 L 240,65 Z"/>
                    <path id="state-WY" class="state-path" fill="#ddd" d="M 235,145 L 350,130 L 345,195 L 275,150 L 235,145 Z"/>
                    <path id="state-CO" class="state-path" fill="#ddd" d="M 275,150 L 345,195 L 340,250 L 275,210 L 275,150 Z"/>
                    <path id="state-NM" class="state-path" fill="#ddd" d="M 270,210 L 340,250 L 335,315 L 270,315 L 270,210 Z"/>
                    <path id="state-ND" class="state-path" fill="#ddd" d="M 355,75 L 430,80 L 425,130 L 350,130 L 355,75 Z"/>
                    <path id="state-SD" class="state-path" fill="#ddd" d="M 350,130 L 425,130 L 420,185 L 345,195 L 350,130 Z"/>
                    <path id="state-NE" class="state-path" fill="#ddd" d="M 345,195 L 420,185 L 415,240 L 340,250 L 345,195 Z"/>
                    <path id="state-KS" class="state-path" fill="#ddd" d="M 340,250 L 415,240 L 410,295 L 335,315 L 340,250 Z"/>
                    <path id="state-OK" class="state-path" fill="#ddd" d="M 335,315 L 410,295 L 405,355 L 335,355 L 335,315 Z"/>
                    <path id="state-TX" class="state-path" fill="#ddd" d="M 335,355 L 405,355 L 400,450 L 295,440 L 335,355 Z"/>
                    <path id="state-MN" class="state-path" fill="#ddd" d="M 430,80 L 485,85 L 480,140 L 425,130 L 430,80 Z"/>
                    <path id="state-IA" class="state-path" fill="#ddd" d="M 420,185 L 480,190 L 475,245 L 415,240 L 420,185 Z"/>
                    <path id="state-MO" class="state-path" fill="#ddd" d="M 415,240 L 475,245 L 470,300 L 410,295 L 415,240 Z"/>
                    <path id="state-AR" class="state-path" fill="#ddd" d="M 410,295 L 470,300 L 465,355 L 405,355 L 410,295 Z"/>
                    <path id="state-LA" class="state-path" fill="#ddd" d="M 405,355 L 465,355 L 460,405 L 400,450 L 405,355 Z"/>
                    <path id="state-WI" class="state-path" fill="#ddd" d="M 485,85 L 530,90 L 525,150 L 480,140 L 485,85 Z"/>
                    <path id="state-IL" class="state-path" fill="#ddd" d="M 480,190 L 525,195 L 520,255 L 475,245 L 480,190 Z"/>
                    <path id="state-MS" class="state-path" fill="#ddd" d="M 465,355 L 510,360 L 505,410 L 460,405 L 465,355 Z"/>
                    <path id="state-AL" class="state-path" fill="#ddd" d="M 510,360 L 555,365 L 550,415 L 505,410 L 510,360 Z"/>
                    <path id="state-TN" class="state-path" fill="#ddd" d="M 470,300 L 555,305 L 550,355 L 465,355 L 470,300 Z"/>
                    <path id="state-KY" class="state-path" fill="#ddd" d="M 475,245 L 555,250 L 550,305 L 470,300 L 475,245 Z"/>
                    <path id="state-IN" class="state-path" fill="#ddd" d="M 525,195 L 570,200 L 565,260 L 520,255 L 525,195 Z"/>
                    <path id="state-MI" class="state-path" fill="#ddd" d="M 530,90 L 580,95 L 575,160 L 525,150 L 530,90 Z"/>
                    <path id="state-OH" class="state-path" fill="#ddd" d="M 570,200 L 615,205 L 610,265 L 565,260 L 570,200 Z"/>
                    <path id="state-WV" class="state-path" fill="#ddd" d="M 555,250 L 615,255 L 610,305 L 550,305 L 555,250 Z"/>
                    <path id="state-VA" class="state-path" fill="#ddd" d="M 610,305 L 670,310 L 665,355 L 610,350 L 610,305 Z"/>
                    <path id="state-NC" class="state-path" fill="#ddd" d="M 550,355 L 665,360 L 660,405 L 550,400 L 550,355 Z"/>
                    <path id="state-SC" class="state-path" fill="#ddd" d="M 550,400 L 615,405 L 610,445 L 550,440 L 550,400 Z"/>
                    <path id="state-GA" class="state-path" fill="#ddd" d="M 550,415 L 600,420 L 595,470 L 545,465 L 550,415 Z"/>
                    <path id="state-FL" class="state-path" fill="#ddd" d="M 595,470 L 645,475 L 640,530 L 585,525 L 595,470 Z"/>
                    <path id="state-PA" class="state-path" fill="#ddd" d="M 615,205 L 680,210 L 675,270 L 610,265 L 615,205 Z"/>
                    <path id="state-NY" class="state-path" fill="#ddd" d="M 580,95 L 680,100 L 675,170 L 575,160 L 580,95 Z"/>
                    <path id="state-VT" class="state-path" fill="#ddd" d="M 680,100 L 705,102 L 700,140 L 675,138 L 680,100 Z"/>
                    <path id="state-NH" class="state-path" fill="#ddd" d="M 705,102 L 730,104 L 725,142 L 700,140 L 705,102 Z"/>
                    <path id="state-ME" class="state-path" fill="#ddd" d="M 730,50 L 780,55 L 775,125 L 725,120 L 730,50 Z"/>
                    <path id="state-MA" class="state-path" fill="#ddd" d="M 700,140 L 750,145 L 745,170 L 695,165 L 700,140 Z"/>
                    <path id="state-RI" class="state-path" fill="#ddd" d="M 745,170 L 760,172 L 757,185 L 742,183 L 745,170 Z"/>
                    <path id="state-CT" class="state-path" fill="#ddd" d="M 695,165 L 745,170 L 740,190 L 690,185 L 695,165 Z"/>
                    <path id="state-NJ" class="state-path" fill="#ddd" d="M 675,270 L 700,275 L 695,310 L 670,305 L 675,270 Z"/>
                    <path id="state-DE" class="state-path" fill="#ddd" d="M 700,275 L 715,277 L 712,295 L 697,293 L 700,275 Z"/>
                    <path id="state-MD" class="state-path" fill="#ddd" d="M 670,305 L 715,310 L 710,340 L 665,335 L 670,305 Z"/>
                </svg>
            </div>
            
            <div class="legend">
                <span class="legend-min">Low</span>
                <div class="legend-scale">
                    <div class="legend-color heat-0"></div>
                    <div class="legend-color heat-1"></div>
                    <div class="legend-color heat-2"></div>
                    <div class="legend-color heat-3"></div>
                    <div class="legend-color heat-4"></div>
                    <div class="legend-color heat-5"></div>
                    <div class="legend-color heat-6"></div>
                    <div class="legend-color heat-7"></div>
                </div>
                <span class="legend-max">High</span>
            </div>
            
            <!-- Tooltip/Info Box -->
            <div id="map-tooltip" class="info-box-hover">
                <div class="state-name">State Name</div>
                <div class="metric-label">Metric Label</div>
                <div class="metric-value">Value</div>
            </div>
        </div>
        
        <div class="info-card">
            <div class="info-card-content">
                <h3 class="state-name">Select a State</h3>
                <div class="metric-value">--</div>
                <p class="metric-description">Click on a state to view insurance metrics</p>
                <a href="#" class="cta-link" style="display: none;">Get Free Quotes →</a>
            </div>
        </div>
    </div>
</div>

<script>
console.log('Insurance map script starting at bottom of DOM - DOM elements should be available immediately');

(function() {
    try {
        console.log('Map initialization function executing with DOM ready...');
        
        // Data definitions for carpenter insurance metrics
        window.DATA = {
        glPremiumPct: {
            AL: { min: 2.8, max: 5.0, midpoint: 3.9, range: "2.8% – 5.0%" },
            AK: { min: 3.2, max: 5.8, midpoint: 4.5, range: "3.2% – 5.8%" },
            AZ: { min: 2.5, max: 4.7, midpoint: 3.6, range: "2.5% – 4.7%" },
            AR: { min: 2.7, max: 4.9, midpoint: 3.8, range: "2.7% – 4.9%" },
            CA: { min: 3.1, max: 5.5, midpoint: 4.3, range: "3.1% – 5.5%" },
            CO: { min: 2.4, max: 4.6, midpoint: 3.5, range: "2.4% – 4.6%" },
            CT: { min: 3.0, max: 5.2, midpoint: 4.1, range: "3.0% – 5.2%" },
            DE: { min: 2.6, max: 4.8, midpoint: 3.7, range: "2.6% – 4.8%" },
            FL: { min: 3.3, max: 5.7, midpoint: 4.5, range: "3.3% – 5.7%" },
            GA: { min: 2.8, max: 5.0, midpoint: 3.9, range: "2.8% – 5.0%" },
            HI: { min: 3.5, max: 5.9, midpoint: 4.7, range: "3.5% – 5.9%" },
            ID: { min: 2.3, max: 4.5, midpoint: 3.4, range: "2.3% – 4.5%" },
            IL: { min: 2.9, max: 5.1, midpoint: 4.0, range: "2.9% – 5.1%" },
            IN: { min: 2.6, max: 4.8, midpoint: 3.7, range: "2.6% – 4.8%" },
            IA: { min: 2.4, max: 4.6, midpoint: 3.5, range: "2.4% – 4.6%" },
            KS: { min: 2.6, max: 4.8, midpoint: 3.7, range: "2.6% – 4.8%" },
            KY: { min: 2.8, max: 5.0, midpoint: 3.9, range: "2.8% – 5.0%" },
            LA: { min: 3.0, max: 5.2, midpoint: 4.1, range: "3.0% – 5.2%" },
            ME: { min: 2.6, max: 4.8, midpoint: 3.7, range: "2.6% – 4.8%" },
            MD: { min: 2.8, max: 5.0, midpoint: 3.9, range: "2.8% – 5.0%" },
            MA: { min: 3.0, max: 5.2, midpoint: 4.1, range: "3.0% – 5.2%" },
            MI: { min: 2.8, max: 5.0, midpoint: 3.9, range: "2.8% – 5.0%" },
            MN: { min: 2.6, max: 4.8, midpoint: 3.7, range: "2.6% – 4.8%" },
            MS: { min: 2.9, max: 5.1, midpoint: 4.0, range: "2.9% – 5.1%" },
            MO: { min: 2.6, max: 4.8, midpoint: 3.7, range: "2.6% – 4.8%" },
            MT: { min: 2.4, max: 4.6, midpoint: 3.5, range: "2.4% – 4.6%" },
            NE: { min: 2.4, max: 4.6, midpoint: 3.5, range: "2.4% – 4.6%" },
            NV: { min: 2.9, max: 5.1, midpoint: 4.0, range: "2.9% – 5.1%" },
            NH: { min: 2.6, max: 4.8, midpoint: 3.7, range: "2.6% – 4.8%" },
            NJ: { min: 3.1, max: 5.5, midpoint: 4.3, range: "3.1% – 5.5%" },
            NM: { min: 2.8, max: 5.0, midpoint: 3.9, range: "2.8% – 5.0%" },
            NY: { min: 3.3, max: 5.7, midpoint: 4.5, range: "3.3% – 5.7%" },
            NC: { min: 2.6, max: 4.8, midpoint: 3.7, range: "2.6% – 4.8%" },
            ND: { min: 2.4, max: 4.6, midpoint: 3.5, range: "2.4% – 4.6%" },
            OH: { min: 2.8, max: 5.0, midpoint: 3.9, range: "2.8% – 5.0%" },
            OK: { min: 2.6, max: 4.8, midpoint: 3.7, range: "2.6% – 4.8%" },
            OR: { min: 2.6, max: 4.8, midpoint: 3.7, range: "2.6% – 4.8%" },
            PA: { min: 2.9, max: 5.1, midpoint: 4.0, range: "2.9% – 5.1%" },
            RI: { min: 3.0, max: 5.2, midpoint: 4.1, range: "3.0% – 5.2%" },
            SC: { min: 2.8, max: 5.0, midpoint: 3.9, range: "2.8% – 5.0%" },
            SD: { min: 2.4, max: 4.6, midpoint: 3.5, range: "2.4% – 4.6%" },
            TN: { min: 2.8, max: 5.0, midpoint: 3.9, range: "2.8% – 5.0%" },
            TX: { min: 2.9, max: 5.1, midpoint: 4.0, range: "2.9% – 5.1%" },
            UT: { min: 2.4, max: 4.6, midpoint: 3.5, range: "2.4% – 4.6%" },
            VT: { min: 2.6, max: 4.8, midpoint: 3.7, range: "2.6% – 4.8%" },
            VA: { min: 2.8, max: 5.0, midpoint: 3.9, range: "2.8% – 5.0%" },
            WA: { min: 2.8, max: 5.0, midpoint: 3.9, range: "2.8% – 5.0%" },
            WV: { min: 2.9, max: 5.1, midpoint: 4.0, range: "2.9% – 5.1%" },
            WI: { min: 2.6, max: 4.8, midpoint: 3.7, range: "2.6% – 4.8%" },
            WY: { min: 2.4, max: 4.6, midpoint: 3.5, range: "2.4% – 4.6%" }
        },
        
        glSavingsPct: {
            AL: 18, AK: 22, AZ: 20, AR: 19, CA: 25, CO: 21, CT: 23, DE: 20, FL: 26, GA: 19,
            HI: 24, ID: 18, IL: 22, IN: 20, IA: 19, KS: 20, KY: 19, LA: 21, ME: 20, MD: 21,
            MA: 24, MI: 21, MN: 20, MS: 19, MO: 20, MT: 18, NE: 19, NV: 22, NH: 20, NJ: 25,
            NM: 20, NY: 26, NC: 20, ND: 18, OH: 21, OK: 20, OR: 21, PA: 22, RI: 23, SC: 19,
            SD: 18, TN: 19, TX: 21, UT: 19, VT: 20, VA: 21, WA: 22, WV: 20, WI: 20, WY: 18
        },
        
        glCompetitiveness: {
            AL: 65, AK: 45, AZ: 75, AR: 60, CA: 85, CO: 80, CT: 70, DE: 65, FL: 90, GA: 75,
            HI: 50, ID: 55, IL: 80, IN: 70, IA: 60, KS: 65, KY: 60, LA: 65, ME: 55, MD: 75,
            MA: 80, MI: 75, MN: 70, MS: 55, MO: 70, MT: 50, NE: 60, NV: 70, NH: 65, NJ: 85,
            NM: 60, NY: 85, NC: 75, ND: 50, OH: 80, OK: 65, OR: 75, PA: 80, RI: 70, SC: 70,
            SD: 55, TN: 70, TX: 85, UT: 65, VT: 60, VA: 75, WA: 80, WV: 55, WI: 70, WY: 50
        },
        
        // Workers' Comp Rate per $100 of payroll - Class 5437 (Carpentry-framing)
        wcRate5437: {
            AL: 6.14, AK: 6.16, AZ: 4.05, AR: 3.26, CA: 5.62, CO: 4.74, CT: 7.86,
            DE: 5.00, FL: 6.23, GA: 8.98, HI: 6.03, ID: 6.58, IL: 9.75,
            IN: 2.83, IA: 5.71, KS: 4.55, KY: 3.87, LA: 9.60, ME: 6.61, MD: 5.50,
            MA: 6.75, MI: 5.88, MN: 8.41, MS: 6.50, MO: 5.44, MT: 5.52, NE: 4.31,
            NV: 8.71, NH: 5.30, NJ: 7.79, NM: 5.17, NY: 8.50, NC: 3.96, ND: 5.45,
            OH: 4.56, OK: 6.37, OR: 5.43, PA: 7.07, RI: 6.19, SC: 5.31, SD: 4.99,
            TN: 3.93, TX: 3.55, UT: 4.39, VT: 7.55, VA: 5.46, WA: 4.67, WV: 2.74,
            WI: 10.03, WY: 3.48
        },
        wcRate5645: {
            AL: 14.07, AK: 9.78, AZ: 10.17, AR: 6.33, CA: 8.46, CO: 7.40, CT: 17.17,
            DE: 9.06, FL: 12.61, GA: 43.42, HI: 10.60, ID: 12.93, IL: 19.23,
            IN: 5.56, IA: 9.65, KS: 10.53, KY: 9.81, LA: 17.76, ME: 10.58, MD: 7.23,
            MA: 11.44, MI: 11.01, MN: 13.70, MS: 11.55, MO: 8.69, MT: 8.79, NE: 7.15,
            NV: 12.58, NH: 9.35, NJ: 13.29, NM: 8.99, NY: 13.37, NC: 6.81, ND: 8.44,
            OH: 8.20, OK: 10.79, OR: 8.84, PA: 12.14, RI: 10.12, SC: 8.38, SD: 8.01,
            TN: 6.95, TX: 6.78, UT: 7.50, VT: 11.26, VA: 8.53, WA: 7.98, WV: 5.94,
            WI: 15.76, WY: 6.42
        }
    };
    
    // State names mapping
    window.STATE_NAMES = {
        AL: "Alabama", AK: "Alaska", AZ: "Arizona", AR: "Arkansas", CA: "California",
        CO: "Colorado", CT: "Connecticut", DE: "Delaware", FL: "Florida", GA: "Georgia",
        HI: "Hawaii", ID: "Idaho", IL: "Illinois", IN: "Indiana", IA: "Iowa",
        KS: "Kansas", KY: "Kentucky", LA: "Louisiana", ME: "Maine", MD: "Maryland",
        MA: "Massachusetts", MI: "Michigan", MN: "Minnesota", MS: "Mississippi",
        MO: "Missouri", MT: "Montana", NE: "Nebraska", NV: "Nevada",
        NH: "New Hampshire", NJ: "New Jersey", NM: "New Mexico", NY: "New York",
        NC: "North Carolina", ND: "North Dakota", OH: "Ohio", OK: "Oklahoma",
        OR: "Oregon", PA: "Pennsylvania", RI: "Rhode Island", SC: "South Carolina",
        SD: "South Dakota", TN: "Tennessee", TX: "Texas", UT: "Utah", VT: "Vermont",
        VA: "Virginia", WA: "Washington", WV: "West Virginia", WI: "Wisconsin", WY: "Wyoming"
    };
    
    // Metric configurations
    window.METRIC_CONFIG = {
        glPremiumPct: {
            label: "GL Premium as % of Revenue",
            format: function(data) { return data.range; },
            description: "General Liability insurance premium as a percentage of contractor revenue",
            reverseScale: false
        },
        glSavingsPct: {
            label: "GL Savings as % of Premium",
            format: function(val) { return val + '%'; },
            description: "Potential savings on General Liability insurance premiums",
            reverseScale: false
        },
        glCompetitiveness: {
            label: "GL Carrier Competitiveness",
            format: function(val) { return val + 'th percentile'; },
            description: "Market competitiveness ranking based on number of carrier quotes",
            reverseScale: false
        },
        wcRate5437: {
            label: "WC Rate per $100 (Class 5437)",
            format: function(val) { return '$' + val.toFixed(2); },
            description: "Workers' Comp rate for Class Code 5437 (Carpentry-framing)",
            reverseScale: true
        },
        wcRate5645: {
            label: "WC Rate per $100 (Class 5645)",
            format: function(val) { return '$' + val.toFixed(2); },
            description: "Workers' Comp rate for Class Code 5645 (Carpentry-interior)",
            reverseScale: true
        }
    };
    
    // Application State
    window.currentMetric = 'glPremiumPct';
    window.currentWCCode = '5437';
    window.selectedState = null;
    
    // Hawaii multi-element fixes
    function normalizeStateCode(stateCode) {
        // Remove any suffix after dash (e.g., HI-2 -> HI)
        return stateCode.split('-')[0];
    }
    
    function getStateEls(stateCode) {
        // Return all elements for a state including multi-part states like Hawaii
        var normalized = normalizeStateCode(stateCode);
        var elements = document.querySelectorAll('[id^="state-' + normalized + '"]');
        return Array.prototype.slice.call(elements);
    }
    
    // Color calculation functions
    function getHeatmapColor(value, min, max, reverseScale) {
        if (value == null || min == null || max == null) {
            return 'heat-0';
        }
        
        reverseScale = reverseScale || false;
        
        var normalized = (value - min) / (max - min);
        
        if (reverseScale) {
            normalized = 1 - normalized;
        }
        
        var heatLevel = Math.floor(normalized * 8);
        return 'heat-' + Math.min(7, Math.max(0, heatLevel));
    }
    
    window.updateMapColors = function() {
        console.log('Updating map colors for metric:', window.currentMetric);
        var metricData = window.DATA[window.currentMetric];
        var config = window.METRIC_CONFIG[window.currentMetric];
        
        if (!metricData || !config) return;
        
        var values = [];
        for (var state in metricData) {
            if (metricData.hasOwnProperty(state)) {
                var val = window.currentMetric === 'glPremiumPct' ? metricData[state].midpoint : metricData[state];
                values.push(val);
            }
        }
        
        var min = Math.min.apply(Math, values);
        var max = Math.max.apply(Math, values);
        
        for (var state in metricData) {
            if (metricData.hasOwnProperty(state)) {
                // Get all elements for this state (handles Hawaii's multiple islands)
                var stateElements = getStateEls(state);
                
                for (var i = 0; i < stateElements.length; i++) {
                    var element = stateElements[i];
                    
                    // Remove all heat classes
                    for (var j = 0; j <= 7; j++) {
                        element.classList.remove('heat-' + j);
                    }
                    
                    var val = window.currentMetric === 'glPremiumPct' ? metricData[state].midpoint : metricData[state];
                    var colorClass = getHeatmapColor(val, min, max, config.reverseScale);
                    element.classList.add(colorClass);
                }
            }
        }
        
        updateLegend(config);
    };
    
    function updateLegend(config) {
        var legendMin = document.querySelector('.legend-min');
        var legendMax = document.querySelector('.legend-max');
        
        if (!legendMin || !legendMax || !config) return;
        
        if (config.reverseScale) {
            legendMin.textContent = 'Better';
            legendMax.textContent = 'Worse';
        } else {
            legendMin.textContent = 'Low';
            legendMax.textContent = 'High';
        }
    }
    
    window.updateInfoCard = function(stateCode) {
        var stateName = window.STATE_NAMES[stateCode];
        var metricData = stateCode && window.DATA[window.currentMetric] ? window.DATA[window.currentMetric][stateCode] : null;
        var config = window.METRIC_CONFIG[window.currentMetric];
        
        var nameElement = document.querySelector('.info-card .state-name');
        if (nameElement) {
            nameElement.textContent = stateName || 'Select a State';
        }
        
        var valueElement = document.querySelector('.info-card .metric-value');
        if (valueElement) {
            if (metricData && config) {
                var formattedValue = window.currentMetric === 'glPremiumPct' 
                    ? config.format(metricData) 
                    : config.format(metricData);
                valueElement.textContent = formattedValue;
            } else {
                valueElement.textContent = '--';
            }
        }
        
        var descElement = document.querySelector('.info-card .metric-description');
        if (descElement && config) {
            descElement.textContent = stateCode ? config.description : 'Click on a state to view insurance metrics';
        }
        
        var ctaLink = document.querySelector('.info-card .cta-link');
        if (ctaLink) {
            if (stateCode && stateName) {
                ctaLink.href = 'https://app.contractornerd.com/';
                ctaLink.textContent = 'Get Free Quotes for ' + stateName + ' →';
                ctaLink.style.display = 'inline-block';
            } else {
                ctaLink.style.display = 'none';
            }
        }
    };
    
    window.handleMetricToggle = function(metric) {
        var buttons = document.querySelectorAll('.metric-btn');
        for (var i = 0; i < buttons.length; i++) {
            buttons[i].classList.remove('active');
        }
        
        var targetBtn = document.querySelector('[data-metric="' + metric + '"]');
        if (targetBtn) {
            targetBtn.classList.add('active');
        }
        
        var wcSubButtons = document.getElementById('wc-sub-buttons');
        if (metric === 'wcRate') {
            wcSubButtons.classList.add('show');
            window.currentMetric = 'wcRate' + window.currentWCCode;
        } else {
            wcSubButtons.classList.remove('show');
            window.currentMetric = metric;
        }
        
        window.updateMapColors();
        
        if (window.selectedState) {
            window.updateInfoCard(window.selectedState);
        }
    };
    
    window.handleWCCodeToggle = function(code) {
        var buttons = document.querySelectorAll('.wc-sub-btn');
        for (var i = 0; i < buttons.length; i++) {
            buttons[i].classList.remove('active');
        }
        
        var btn = document.querySelector('[data-wc-code="' + code + '"]');
        if (btn) btn.classList.add('active');
        window.currentWCCode = code;
        window.currentMetric = 'wcRate' + code;
        window.updateMapColors();
        if (window.selectedState) window.updateInfoCard(window.selectedState);
    };
    
    function populateDropdown() {
        var dropdown = document.getElementById('state-dropdown');
        if (!dropdown) return;
        
        var stateEntries = [];
        for (var code in window.STATE_NAMES) {
            if (window.STATE_NAMES.hasOwnProperty(code)) {
                stateEntries.push([code, window.STATE_NAMES[code]]);
            }
        }
        
        stateEntries.sort(function(a, b) {
            return a[1].localeCompare(b[1]);
        });
        
        for (var i = 0; i < stateEntries.length; i++) {
            var code = stateEntries[i][0];
            var name = stateEntries[i][1];
            var option = document.createElement('option');
            option.value = code;
            option.textContent = name;
            dropdown.appendChild(option);
        }
    }
    
    function initializeToggles() {
        var buttons = document.querySelectorAll('.metric-btn');
        for (var i = 0; i < buttons.length; i++) {
            var btn = buttons[i];
            btn.addEventListener('click', function() {
                window.handleMetricToggle(this.dataset.metric);
            });
        }
        
        var wcButtons = document.querySelectorAll('.wc-sub-btn');
        for (var j = 0; j < wcButtons.length; j++) {
            var wcBtn = wcButtons[j];
            wcBtn.addEventListener('click', function() {
                window.handleWCCodeToggle(this.dataset.wcCode);
            });
        }
    }
    
    function initializeDropdown() {
        var dropdown = document.getElementById('state-dropdown');
        if (dropdown) {
            dropdown.addEventListener('change', function() {
                if (this.value) {
                    window.selectedState = this.value;
                    window.updateInfoCard(this.value);
                }
            });
        }
    }
    
    window.showTooltip = function(event, stateCode) {
        var normalizedCode = normalizeStateCode(stateCode);
        var tooltip = document.getElementById('map-tooltip');
        var metricData = window.DATA[window.currentMetric] && window.DATA[window.currentMetric][normalizedCode] ? window.DATA[window.currentMetric][normalizedCode] : null;
        var config = window.METRIC_CONFIG[window.currentMetric];
        
        if (metricData && tooltip && config) {
            var formattedValue = window.currentMetric === 'glPremiumPct' 
                ? config.format(metricData) 
                : config.format(metricData);
            
            var stateNameEl = tooltip.querySelector('.state-name');
            var metricLabelEl = tooltip.querySelector('.metric-label');
            var metricValueEl = tooltip.querySelector('.metric-value');
            
            if (stateNameEl) stateNameEl.textContent = window.STATE_NAMES[normalizedCode] || '';
            if (metricLabelEl) metricLabelEl.textContent = config.label || '';
            if (metricValueEl) metricValueEl.textContent = formattedValue || '';
            
            var rect = event.target.getBoundingClientRect();
            var mapWrapper = document.querySelector('.map-wrapper');
            if (!mapWrapper) return;
            
            var wrapperRect = mapWrapper.getBoundingClientRect();
            
            var left = rect.right - wrapperRect.left + 10;
            var top = rect.top - wrapperRect.top + (rect.height / 2) - 40;
            
            var tooltipWidth = 220;
            if (left + tooltipWidth > wrapperRect.width) {
                left = rect.left - wrapperRect.left - tooltipWidth - 10;
            }
            if (top < 10) top = 10;
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.style.display = 'block';
        }
    };
    
    window.hideTooltip = function() {
        var tooltip = document.getElementById('map-tooltip');
        if (tooltip) {
            tooltip.style.display = 'none';
        }
    };
    
    window.handleStateClick = function(stateCode) {
        var normalizedCode = normalizeStateCode(stateCode);
        
        // Get all elements for this state (handles Hawaii's multiple islands)
        var stateElements = getStateEls(normalizedCode);
        
        if (stateElements.length === 0) return;
        
        var isAlreadySelected = stateElements[0].classList.contains('selected');
        
        // Clear all selections
        var allStates = document.querySelectorAll('.state-path');
        for (var i = 0; i < allStates.length; i++) {
            allStates[i].classList.remove('selected');
        }
        
        if (isAlreadySelected) {
            window.selectedState = null;
            window.updateInfoCard(null);
        } else {
            // Select all elements for this state
            for (var j = 0; j < stateElements.length; j++) {
                stateElements[j].classList.add('selected');
            }
            window.selectedState = normalizedCode;
            window.updateInfoCard(normalizedCode);
        }
        
        window.hideTooltip();
    };
    
    window.handleStateHover = function(event, stateCode) {
        if (window.innerWidth > 768) {
            window.showTooltip(event, stateCode);
        }
    };
    
    window.handleStateLeave = function() {
        window.hideTooltip();
    };
    
    function initializeStateInteractions() {
        console.log('Initializing state interactions...');
        var states = document.querySelectorAll('.state-path');
        
        for (var i = 0; i < states.length; i++) {
            var state = states[i];
            var stateCode = normalizeStateCode(state.id.replace('state-', ''));
            
            state.addEventListener('click', function(code) {
                return function() {
                    window.handleStateClick(code);
                };
            }(stateCode));
            
            state.addEventListener('mouseover', function(code) {
                return function(e) {
                    window.handleStateHover(e, code);
                };
            }(stateCode));
            
            state.addEventListener('mouseout', function() {
                window.handleStateLeave();
            });
            
            state.style.cursor = 'pointer';
            state.style.pointerEvents = 'all';
        }
    }
    
    function initializeMap() {
        if (window.mapInitialized) return;
        window.mapInitialized = true;
        
        console.log('Initializing map - DOM already exists, no polling needed');
        initializeStateInteractions();
        window.updateMapColors();
        populateDropdown();
        initializeToggles();
        initializeDropdown();
        window.updateInfoCard(null);
        console.log('Map initialization complete!');
    }
    
    // Simple initialization since DOM exists when script runs at bottom
    var container = document.getElementById('insurance-map-container');
    if (container) {
        console.log('Container found immediately, initializing...');
        initializeMap();
    } else {
        console.error('Container not found - this should not happen with bottom script placement');
    }
    
    } catch (error) {
        // Log error if console exists
        if (typeof console !== 'undefined' && console.error) {
            console.error('Map initialization error:', error);
        }
    }
})();
</script>
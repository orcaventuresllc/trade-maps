<style>
    /* Container Styles */
    #insurance-map-container {
        max-width: 1160px;
        margin: 0 auto;
        padding: 20px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        color: #333;
    }
    
    /* Header Styles */
    .map-header {
        text-align: center;
        margin-bottom: 30px;
    }
    
    .map-header h2 {
        font-size: 28px;
        font-weight: 600;
        margin-bottom: 10px;
        color: #1a1a1a;
    }
    
    .map-subtitle {
        font-size: 16px;
        color: #666;
        margin: 0;
    }
    
    /* Toggle Button Styles */
    .metric-toggles {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }
    
    .metric-btn {
        padding: 10px 20px;
        border: 2px solid #ddd;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        color: #555;
    }
    
    .metric-btn:hover {
        background: #f5f5f5;
        border-color: #999;
    }
    
    .metric-btn.active {
        background: #2563eb;
        color: white;
        border-color: #2563eb;
    }
    
    /* Main content layout */
    .map-content-container {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    /* Map Wrapper */
    .map-wrapper {
        position: relative;
        background: #f9fafb;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        flex: 1;
    }
    
    #us-map-svg {
        width: 100%;
        height: auto;
        display: block;
    }
    
    #us-map-svg svg {
        width: 100%;
        height: auto;
        display: block;
    }
    
    /* State Styles */
    .state-path {
        stroke: #fff;
        stroke-width: 0.5;
        cursor: pointer;
        transition: all 0.2s ease;
        pointer-events: all !important;
        z-index: 10;
    }
    
    .state-path:hover {
        stroke: #333;
        stroke-width: 1.5;
        filter: brightness(0.9);
    }
    
    .state-path.selected {
        stroke: #f73333;
        stroke-width: 2;
        fill: #ffcccc !important;
    }
    
    /* Info Box Styles (replaces tooltip) */
    .info-box-hover {
        position: absolute;
        background: white;
        padding: 16px 20px;
        border-radius: 8px;
        min-width: 200px;
        pointer-events: none;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: 1px solid #e0e0e0;
    }
    
    .info-box-hover .state-name {
        font-size: 18px;
        font-weight: 600;
        color: #1a1a1a;
        margin: 0 0 8px 0;
    }
    
    .info-box-hover .metric-label {
        font-size: 12px;
        color: #666;
        margin: 0 0 4px 0;
    }
    
    .info-box-hover .metric-value {
        font-size: 24px;
        font-weight: 700;
        color: #2563eb;
        margin: 0;
    }
    
    /* Mobile Selector (hidden by default) */
    .mobile-selector {
        display: none;
        margin-bottom: 30px;
        text-align: center;
    }
    
    .mobile-selector label {
        display: block;
        margin-bottom: 10px;
        font-weight: 500;
        color: #555;
    }
    
    #state-dropdown {
        width: 100%;
        max-width: 300px;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        background: white;
        cursor: pointer;
    }
    
    /* Info Card */
    .info-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        width: 280px;
        flex-shrink: 0;
        align-self: flex-start;
    }
    
    .info-card-content {
        text-align: center;
    }
    
    .state-name {
        font-size: 20px;
        font-weight: 600;
        margin: 0 0 10px 0;
        color: #1a1a1a;
    }
    
    .metric-value {
        font-size: 28px;
        font-weight: 700;
        color: #2563eb;
        margin: 0 0 15px 0;
    }
    
    .metric-description {
        font-size: 14px;
        color: #666;
        line-height: 1.4;
        margin: 0 0 20px 0;
    }
    
    .cta-link {
        display: inline-block;
        background: #2563eb;
        color: white;
        padding: 10px 16px;
        border-radius: 6px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.2s ease;
    }
    
    .cta-link:hover {
        background: #1d4ed8;
        text-decoration: none;
        color: white;
    }
    
    /* Heatmap Colors */
    .heat-0 { fill: #F7F7F7; }
    .heat-1 { fill: #FDF4C4; }
    .heat-2 { fill: #FEE391; }
    .heat-3 { fill: #FEC44F; }
    .heat-4 { fill: #FE9929; }
    .heat-5 { fill: #EC7014; }
    .heat-6 { fill: #CC4C02; }
    .heat-7 { fill: #993404; }
    
    /* Legend */
    .legend {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 15px;
        gap: 8px;
        font-size: 12px;
        color: #666;
    }
    
    .legend-scale {
        display: flex;
        border-radius: 4px;
        overflow: hidden;
        border: 1px solid #ddd;
    }
    
    .legend-color {
        width: 20px;
        height: 16px;
    }
    
    .legend-color.heat-0 { background: #F7F7F7; }
    .legend-color.heat-1 { background: #FDF4C4; }
    .legend-color.heat-2 { background: #FEE391; }
    .legend-color.heat-3 { background: #FEC44F; }
    .legend-color.heat-4 { background: #FE9929; }
    .legend-color.heat-5 { background: #EC7014; }
    .legend-color.heat-6 { background: #CC4C02; }
    .legend-color.heat-7 { background: #993404; }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .map-content-container {
            flex-direction: column;
        }
        
        .info-card {
            width: 100%;
            order: -1;
        }
        
        .mobile-selector {
            display: block;
        }
        
        .state-path:hover {
            stroke: #fff;
            stroke-width: 0.5;
            filter: none;
        }
    }
    
    @media (max-width: 480px) {
        #insurance-map-container {
            padding: 15px;
        }
        
        .map-header h2 {
            font-size: 22px;
        }
        
        .metric-toggles {
            gap: 8px;
        }
        
        .metric-btn {
            padding: 8px 12px;
            font-size: 12px;
        }
    }
    
    /* Tooltip/Info Box Styles */
    #map-tooltip {
        position: absolute;
        background: white;
        padding: 12px 16px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: 1px solid #e0e0e0;
        pointer-events: none;
        z-index: 1000;
        display: none;
        min-width: 180px;
    }
    
    #map-tooltip .state-name {
        font-size: 16px;
        font-weight: 600;
        color: #1a1a1a;
        margin: 0 0 6px 0;
    }
    
    #map-tooltip .metric-label {
        font-size: 11px;
        color: #666;
        margin: 0 0 3px 0;
    }
    
    #map-tooltip .metric-value {
        font-size: 18px;
        font-weight: 700;
        color: #2563eb;
        margin: 0;
    }
</style>

<div id="insurance-map-container">
    <div class="map-header">
        <h2>Contractor Insurance Marketplace</h2>
        <p class="map-subtitle">Interactive state-by-state insurance data visualization</p>
    </div>
    
    <div class="metric-toggles">
        <button class="metric-btn active" data-metric="glPremiumPct" onclick="window.handleMetricToggle('glPremiumPct')">
            GL Premium %
        </button>
        <button class="metric-btn" data-metric="glSavingsPct" onclick="window.handleMetricToggle('glSavingsPct')">
            GL Savings %
        </button>
        <button class="metric-btn" data-metric="glCompetitiveness" onclick="window.handleMetricToggle('glCompetitiveness')">
            GL Competitiveness
        </button>
        <button class="metric-btn" data-metric="wcRate" onclick="window.handleMetricToggle('wcRate')">
            WC Rate
        </button>
    </div>
    
    <div class="mobile-selector">
        <label for="state-dropdown">Select a State:</label>
        <select id="state-dropdown">
            <option value="">Choose a state...</option>
        </select>
    </div>
    
    <div class="map-content-container">
        <div class="map-wrapper">
            <div id="us-map-svg">
                <svg viewBox="0 0 1000 600" xmlns="http://www.w3.org/2000/svg">
                    <!-- Alaska -->
                    <path id="state-AK" class="state-path" fill="#ddd" d="M 158,458 L 177,471 L 200,464 L 213,481 L 208,500 L 223,515 L 245,510 L 268,525 L 271,540 L 285,546 L 294,535 L 320,548 L 338,540 L 350,520 L 362,530 L 375,522 L 388,532 L 403,525 L 418,532 L 430,520 L 445,525 L 460,515 L 475,520 L 488,510 L 500,520 L 515,512 L 528,520 L 540,510 L 555,515 L 568,505 L 580,512 L 595,505 L 608,512 L 620,500 L 635,505 L 648,495 L 660,502 L 675,495 L 688,502 L 700,490 L 715,495 L 728,485 L 740,492 L 755,485 L 768,492 L 780,480 L 795,485 L 808,475 L 820,482 L 835,475 L 848,482 L 860,470 L 875,475 L 888,465 L 900,472 L 915,465 L 928,472 L 940,460 L 955,465 L 968,455 L 980,462 L 995,455 L 1008,462 L 1020,450 L 1035,455 L 1048,445 L 1060,452 L 1075,445 L 1088,452 L 1100,440 L 1115,445 L 1128,435 L 1140,442 L 1155,435 L 1168,442 L 1180,430 L 1195,435 L 1208,425 L 1220,432 L 1235,425 L 1248,432 L 1260,420 L 1275,425 L 1288,415 L 1300,422" onclick="window.handleStateClick('AK')" onmouseover="window.handleStateHover(event, 'AK')" onmouseout="window.handleStateLeave()"/>
                    
                    <!-- Hawaii -->
                    <circle id="state-HI" class="state-path" cx="250" cy="450" r="8" fill="#ddd" onclick="window.handleStateClick('HI')" onmouseover="window.handleStateHover(event, 'HI')" onmouseout="window.handleStateLeave()"/>
                    <circle id="state-HI-2" class="state-path" cx="265" cy="445" r="6" fill="#ddd" onclick="window.handleStateClick('HI')" onmouseover="window.handleStateHover(event, 'HI')" onmouseout="window.handleStateLeave()"/>
                    <circle id="state-HI-3" class="state-path" cx="280" cy="440" r="5" fill="#ddd" onclick="window.handleStateClick('HI')" onmouseover="window.handleStateHover(event, 'HI')" onmouseout="window.handleStateLeave()"/>
                    <circle id="state-HI-4" class="state-path" cx="295" cy="435" r="4" fill="#ddd" onclick="window.handleStateClick('HI')" onmouseover="window.handleStateHover(event, 'HI')" onmouseout="window.handleStateLeave()"/>
                    
                    <!-- Continental US States -->
                    <path id="state-WA" class="state-path" fill="#ddd" d="M 118,50 L 200,60 L 200,125 L 118,115 Z" onclick="window.handleStateClick('WA')" onmouseover="window.handleStateHover(event, 'WA')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-OR" class="state-path" fill="#ddd" d="M 118,115 L 200,125 L 195,185 L 118,175 Z" onclick="window.handleStateClick('OR')" onmouseover="window.handleStateHover(event, 'OR')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-CA" class="state-path" fill="#ddd" d="M 118,175 L 195,185 L 185,315 L 108,305 Z" onclick="window.handleStateClick('CA')" onmouseover="window.handleStateHover(event, 'CA')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-NV" class="state-path" fill="#ddd" d="M 195,185 L 235,190 L 230,270 L 185,315 L 195,185 Z" onclick="window.handleStateClick('NV')" onmouseover="window.handleStateHover(event, 'NV')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-ID" class="state-path" fill="#ddd" d="M 200,60 L 240,65 L 235,145 L 200,125 L 200,60 Z" onclick="window.handleStateClick('ID')" onmouseover="window.handleStateHover(event, 'ID')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-UT" class="state-path" fill="#ddd" d="M 235,145 L 275,150 L 270,210 L 235,190 L 235,145 Z" onclick="window.handleStateClick('UT')" onmouseover="window.handleStateHover(event, 'UT')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-AZ" class="state-path" fill="#ddd" d="M 230,270 L 275,275 L 270,315 L 185,315 L 230,270 Z" onclick="window.handleStateClick('AZ')" onmouseover="window.handleStateHover(event, 'AZ')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-MT" class="state-path" fill="#ddd" d="M 240,65 L 355,75 L 350,130 L 235,145 L 240,65 Z" onclick="window.handleStateClick('MT')" onmouseover="window.handleStateHover(event, 'MT')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-WY" class="state-path" fill="#ddd" d="M 235,145 L 350,130 L 345,195 L 275,150 L 235,145 Z" onclick="window.handleStateClick('WY')" onmouseover="window.handleStateHover(event, 'WY')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-CO" class="state-path" fill="#ddd" d="M 275,150 L 345,195 L 340,250 L 275,210 L 275,150 Z" onclick="window.handleStateClick('CO')" onmouseover="window.handleStateHover(event, 'CO')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-NM" class="state-path" fill="#ddd" d="M 270,210 L 340,250 L 335,315 L 270,315 L 270,210 Z" onclick="window.handleStateClick('NM')" onmouseover="window.handleStateHover(event, 'NM')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-ND" class="state-path" fill="#ddd" d="M 355,75 L 430,80 L 425,130 L 350,130 L 355,75 Z" onclick="window.handleStateClick('ND')" onmouseover="window.handleStateHover(event, 'ND')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-SD" class="state-path" fill="#ddd" d="M 350,130 L 425,130 L 420,185 L 345,195 L 350,130 Z" onclick="window.handleStateClick('SD')" onmouseover="window.handleStateHover(event, 'SD')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-NE" class="state-path" fill="#ddd" d="M 345,195 L 420,185 L 415,240 L 340,250 L 345,195 Z" onclick="window.handleStateClick('NE')" onmouseover="window.handleStateHover(event, 'NE')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-KS" class="state-path" fill="#ddd" d="M 340,250 L 415,240 L 410,295 L 335,315 L 340,250 Z" onclick="window.handleStateClick('KS')" onmouseover="window.handleStateHover(event, 'KS')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-OK" class="state-path" fill="#ddd" d="M 335,315 L 410,295 L 405,355 L 335,355 L 335,315 Z" onclick="window.handleStateClick('OK')" onmouseover="window.handleStateHover(event, 'OK')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-TX" class="state-path" fill="#ddd" d="M 335,355 L 405,355 L 400,450 L 295,440 L 335,355 Z" onclick="window.handleStateClick('TX')" onmouseover="window.handleStateHover(event, 'TX')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-MN" class="state-path" fill="#ddd" d="M 430,80 L 485,85 L 480,140 L 425,130 L 430,80 Z" onclick="window.handleStateClick('MN')" onmouseover="window.handleStateHover(event, 'MN')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-IA" class="state-path" fill="#ddd" d="M 420,185 L 480,190 L 475,245 L 415,240 L 420,185 Z" onclick="window.handleStateClick('IA')" onmouseover="window.handleStateHover(event, 'IA')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-MO" class="state-path" fill="#ddd" d="M 415,240 L 475,245 L 470,300 L 410,295 L 415,240 Z" onclick="window.handleStateClick('MO')" onmouseover="window.handleStateHover(event, 'MO')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-AR" class="state-path" fill="#ddd" d="M 410,295 L 470,300 L 465,355 L 405,355 L 410,295 Z" onclick="window.handleStateClick('AR')" onmouseover="window.handleStateHover(event, 'AR')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-LA" class="state-path" fill="#ddd" d="M 405,355 L 465,355 L 460,405 L 400,450 L 405,355 Z" onclick="window.handleStateClick('LA')" onmouseover="window.handleStateHover(event, 'LA')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-WI" class="state-path" fill="#ddd" d="M 485,85 L 530,90 L 525,150 L 480,140 L 485,85 Z" onclick="window.handleStateClick('WI')" onmouseover="window.handleStateHover(event, 'WI')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-IL" class="state-path" fill="#ddd" d="M 480,190 L 525,195 L 520,255 L 475,245 L 480,190 Z" onclick="window.handleStateClick('IL')" onmouseover="window.handleStateHover(event, 'IL')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-MS" class="state-path" fill="#ddd" d="M 465,355 L 510,360 L 505,410 L 460,405 L 465,355 Z" onclick="window.handleStateClick('MS')" onmouseover="window.handleStateHover(event, 'MS')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-AL" class="state-path" fill="#ddd" d="M 510,360 L 555,365 L 550,415 L 505,410 L 510,360 Z" onclick="window.handleStateClick('AL')" onmouseover="window.handleStateHover(event, 'AL')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-TN" class="state-path" fill="#ddd" d="M 470,300 L 555,305 L 550,355 L 465,355 L 470,300 Z" onclick="window.handleStateClick('TN')" onmouseover="window.handleStateHover(event, 'TN')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-KY" class="state-path" fill="#ddd" d="M 475,245 L 555,250 L 550,305 L 470,300 L 475,245 Z" onclick="window.handleStateClick('KY')" onmouseover="window.handleStateHover(event, 'KY')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-IN" class="state-path" fill="#ddd" d="M 525,195 L 570,200 L 565,260 L 520,255 L 525,195 Z" onclick="window.handleStateClick('IN')" onmouseover="window.handleStateHover(event, 'IN')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-MI" class="state-path" fill="#ddd" d="M 530,90 L 580,95 L 575,160 L 525,150 L 530,90 Z" onclick="window.handleStateClick('MI')" onmouseover="window.handleStateHover(event, 'MI')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-OH" class="state-path" fill="#ddd" d="M 570,200 L 615,205 L 610,265 L 565,260 L 570,200 Z" onclick="window.handleStateClick('OH')" onmouseover="window.handleStateHover(event, 'OH')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-WV" class="state-path" fill="#ddd" d="M 555,250 L 615,255 L 610,305 L 550,305 L 555,250 Z" onclick="window.handleStateClick('WV')" onmouseover="window.handleStateHover(event, 'WV')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-VA" class="state-path" fill="#ddd" d="M 610,305 L 670,310 L 665,355 L 610,350 L 610,305 Z" onclick="window.handleStateClick('VA')" onmouseover="window.handleStateHover(event, 'VA')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-NC" class="state-path" fill="#ddd" d="M 550,355 L 665,360 L 660,405 L 550,400 L 550,355 Z" onclick="window.handleStateClick('NC')" onmouseover="window.handleStateHover(event, 'NC')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-SC" class="state-path" fill="#ddd" d="M 550,400 L 615,405 L 610,445 L 550,440 L 550,400 Z" onclick="window.handleStateClick('SC')" onmouseover="window.handleStateHover(event, 'SC')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-GA" class="state-path" fill="#ddd" d="M 550,415 L 600,420 L 595,470 L 545,465 L 550,415 Z" onclick="window.handleStateClick('GA')" onmouseover="window.handleStateHover(event, 'GA')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-FL" class="state-path" fill="#ddd" d="M 595,470 L 645,475 L 640,530 L 585,525 L 595,470 Z" onclick="window.handleStateClick('FL')" onmouseover="window.handleStateHover(event, 'FL')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-PA" class="state-path" fill="#ddd" d="M 615,205 L 680,210 L 675,270 L 610,265 L 615,205 Z" onclick="window.handleStateClick('PA')" onmouseover="window.handleStateHover(event, 'PA')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-NY" class="state-path" fill="#ddd" d="M 580,95 L 680,100 L 675,170 L 575,160 L 580,95 Z" onclick="window.handleStateClick('NY')" onmouseover="window.handleStateHover(event, 'NY')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-VT" class="state-path" fill="#ddd" d="M 680,100 L 705,102 L 700,140 L 675,138 L 680,100 Z" onclick="window.handleStateClick('VT')" onmouseover="window.handleStateHover(event, 'VT')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-NH" class="state-path" fill="#ddd" d="M 705,102 L 730,104 L 725,142 L 700,140 L 705,102 Z" onclick="window.handleStateClick('NH')" onmouseover="window.handleStateHover(event, 'NH')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-ME" class="state-path" fill="#ddd" d="M 730,50 L 780,55 L 775,125 L 725,120 L 730,50 Z" onclick="window.handleStateClick('ME')" onmouseover="window.handleStateHover(event, 'ME')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-MA" class="state-path" fill="#ddd" d="M 700,140 L 750,145 L 745,170 L 695,165 L 700,140 Z" onclick="window.handleStateClick('MA')" onmouseover="window.handleStateHover(event, 'MA')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-RI" class="state-path" fill="#ddd" d="M 745,170 L 760,172 L 757,185 L 742,183 L 745,170 Z" onclick="window.handleStateClick('RI')" onmouseover="window.handleStateHover(event, 'RI')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-CT" class="state-path" fill="#ddd" d="M 695,165 L 745,170 L 740,190 L 690,185 L 695,165 Z" onclick="window.handleStateClick('CT')" onmouseover="window.handleStateHover(event, 'CT')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-NJ" class="state-path" fill="#ddd" d="M 675,270 L 700,275 L 695,310 L 670,305 L 675,270 Z" onclick="window.handleStateClick('NJ')" onmouseover="window.handleStateHover(event, 'NJ')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-DE" class="state-path" fill="#ddd" d="M 700,275 L 715,277 L 712,295 L 697,293 L 700,275 Z" onclick="window.handleStateClick('DE')" onmouseover="window.handleStateHover(event, 'DE')" onmouseout="window.handleStateLeave()"/>
                    <path id="state-MD" class="state-path" fill="#ddd" d="M 670,305 L 715,310 L 710,340 L 665,335 L 670,305 Z" onclick="window.handleStateClick('MD')" onmouseover="window.handleStateHover(event, 'MD')" onmouseout="window.handleStateLeave()"/>
                </svg>
            </div>
            
            <div class="legend">
                <span class="legend-min">Low</span>
                <div class="legend-scale">
                    <div class="legend-color heat-0"></div>
                    <div class="legend-color heat-1"></div>
                    <div class="legend-color heat-2"></div>
                    <div class="legend-color heat-3"></div>
                    <div class="legend-color heat-4"></div>
                    <div class="legend-color heat-5"></div>
                    <div class="legend-color heat-6"></div>
                    <div class="legend-color heat-7"></div>
                </div>
                <span class="legend-max">High</span>
            </div>
            
            <!-- Tooltip/Info Box -->
            <div id="map-tooltip" class="info-box-hover">
                <div class="state-name">State Name</div>
                <div class="metric-label">Metric Label</div>
                <div class="metric-value">Value</div>
            </div>
        </div>
        
        <div class="info-card">
            <div class="info-card-content">
                <h3 class="state-name">Select a State</h3>
                <div class="metric-value">--</div>
                <p class="metric-description">Click on a state to view insurance metrics</p>
                <a href="#" class="cta-link" style="display: none;">Get Free Quotes →</a>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    // Data definitions
    window.DATA = {
        glPremiumPct: {
            AL: { min: 0.45, max: 0.85, midpoint: 0.65, range: "0.45% - 0.85%" },
            AK: { min: 0.55, max: 0.95, midpoint: 0.75, range: "0.55% - 0.95%" },
            AZ: { min: 0.40, max: 0.80, midpoint: 0.60, range: "0.40% - 0.80%" },
            AR: { min: 0.50, max: 0.90, midpoint: 0.70, range: "0.50% - 0.90%" },
            CA: { min: 0.60, max: 1.00, midpoint: 0.80, range: "0.60% - 1.00%" },
            CO: { min: 0.35, max: 0.75, midpoint: 0.55, range: "0.35% - 0.75%" },
            CT: { min: 0.55, max: 0.95, midpoint: 0.75, range: "0.55% - 0.95%" },
            DE: { min: 0.40, max: 0.80, midpoint: 0.60, range: "0.40% - 0.80%" },
            FL: { min: 0.65, max: 1.05, midpoint: 0.85, range: "0.65% - 1.05%" },
            GA: { min: 0.45, max: 0.85, midpoint: 0.65, range: "0.45% - 0.85%" },
            HI: { min: 0.70, max: 1.10, midpoint: 0.90, range: "0.70% - 1.10%" },
            ID: { min: 0.30, max: 0.70, midpoint: 0.50, range: "0.30% - 0.70%" },
            IL: { min: 0.50, max: 0.90, midpoint: 0.70, range: "0.50% - 0.90%" },
            IN: { min: 0.40, max: 0.80, midpoint: 0.60, range: "0.40% - 0.80%" },
            IA: { min: 0.35, max: 0.75, midpoint: 0.55, range: "0.35% - 0.75%" },
            KS: { min: 0.40, max: 0.80, midpoint: 0.60, range: "0.40% - 0.80%" },
            KY: { min: 0.45, max: 0.85, midpoint: 0.65, range: "0.45% - 0.85%" },
            LA: { min: 0.55, max: 0.95, midpoint: 0.75, range: "0.55% - 0.95%" },
            ME: { min: 0.40, max: 0.80, midpoint: 0.60, range: "0.40% - 0.80%" },
            MD: { min: 0.45, max: 0.85, midpoint: 0.65, range: "0.45% - 0.85%" },
            MA: { min: 0.55, max: 0.95, midpoint: 0.75, range: "0.55% - 0.95%" },
            MI: { min: 0.45, max: 0.85, midpoint: 0.65, range: "0.45% - 0.85%" },
            MN: { min: 0.40, max: 0.80, midpoint: 0.60, range: "0.40% - 0.80%" },
            MS: { min: 0.50, max: 0.90, midpoint: 0.70, range: "0.50% - 0.90%" },
            MO: { min: 0.40, max: 0.80, midpoint: 0.60, range: "0.40% - 0.80%" },
            MT: { min: 0.35, max: 0.75, midpoint: 0.55, range: "0.35% - 0.75%" },
            NE: { min: 0.35, max: 0.75, midpoint: 0.55, range: "0.35% - 0.75%" },
            NV: { min: 0.50, max: 0.90, midpoint: 0.70, range: "0.50% - 0.90%" },
            NH: { min: 0.40, max: 0.80, midpoint: 0.60, range: "0.40% - 0.80%" },
            NJ: { min: 0.60, max: 1.00, midpoint: 0.80, range: "0.60% - 1.00%" },
            NM: { min: 0.45, max: 0.85, midpoint: 0.65, range: "0.45% - 0.85%" },
            NY: { min: 0.65, max: 1.05, midpoint: 0.85, range: "0.65% - 1.05%" },
            NC: { min: 0.40, max: 0.80, midpoint: 0.60, range: "0.40% - 0.80%" },
            ND: { min: 0.35, max: 0.75, midpoint: 0.55, range: "0.35% - 0.75%" },
            OH: { min: 0.45, max: 0.85, midpoint: 0.65, range: "0.45% - 0.85%" },
            OK: { min: 0.40, max: 0.80, midpoint: 0.60, range: "0.40% - 0.80%" },
            OR: { min: 0.40, max: 0.80, midpoint: 0.60, range: "0.40% - 0.80%" },
            PA: { min: 0.50, max: 0.90, midpoint: 0.70, range: "0.50% - 0.90%" },
            RI: { min: 0.55, max: 0.95, midpoint: 0.75, range: "0.55% - 0.95%" },
            SC: { min: 0.45, max: 0.85, midpoint: 0.65, range: "0.45% - 0.85%" },
            SD: { min: 0.35, max: 0.75, midpoint: 0.55, range: "0.35% - 0.75%" },
            TN: { min: 0.45, max: 0.85, midpoint: 0.65, range: "0.45% - 0.85%" },
            TX: { min: 0.50, max: 0.90, midpoint: 0.70, range: "0.50% - 0.90%" },
            UT: { min: 0.35, max: 0.75, midpoint: 0.55, range: "0.35% - 0.75%" },
            VT: { min: 0.40, max: 0.80, midpoint: 0.60, range: "0.40% - 0.80%" },
            VA: { min: 0.45, max: 0.85, midpoint: 0.65, range: "0.45% - 0.85%" },
            WA: { min: 0.45, max: 0.85, midpoint: 0.65, range: "0.45% - 0.85%" },
            WV: { min: 0.50, max: 0.90, midpoint: 0.70, range: "0.50% - 0.90%" },
            WI: { min: 0.40, max: 0.80, midpoint: 0.60, range: "0.40% - 0.80%" },
            WY: { min: 0.35, max: 0.75, midpoint: 0.55, range: "0.35% - 0.75%" }
        },
        glSavingsPct: {
            AL: 18, AK: 22, AZ: 20, AR: 19, CA: 25, CO: 21, CT: 23, DE: 20, FL: 26, GA: 19,
            HI: 24, ID: 18, IL: 22, IN: 20, IA: 19, KS: 20, KY: 19, LA: 21, ME: 20, MD: 21,
            MA: 24, MI: 21, MN: 20, MS: 19, MO: 20, MT: 18, NE: 19, NV: 22, NH: 20, NJ: 25,
            NM: 20, NY: 26, NC: 20, ND: 18, OH: 21, OK: 20, OR: 21, PA: 22, RI: 23, SC: 19,
            SD: 18, TN: 19, TX: 21, UT: 19, VT: 20, VA: 21, WA: 22, WV: 20, WI: 20, WY: 18
        },
        glCompetitiveness: {
            AL: 65, AK: 45, AZ: 75, AR: 60, CA: 85, CO: 80, CT: 70, DE: 65, FL: 90, GA: 75,
            HI: 50, ID: 55, IL: 80, IN: 70, IA: 60, KS: 65, KY: 60, LA: 65, ME: 55, MD: 75,
            MA: 80, MI: 75, MN: 70, MS: 55, MO: 70, MT: 50, NE: 60, NV: 70, NH: 65, NJ: 85,
            NM: 60, NY: 85, NC: 75, ND: 50, OH: 80, OK: 65, OR: 75, PA: 80, RI: 70, SC: 70,
            SD: 55, TN: 70, TX: 85, UT: 65, VT: 60, VA: 75, WA: 80, WV: 55, WI: 70, WY: 50
        },
        wcRate: {
            AL: 2.15, AK: 3.25, AZ: 1.95, AR: 2.35, CA: 2.85, CO: 2.10, CT: 2.55, DE: 1.85, FL: 2.75, GA: 2.25,
            HI: 3.15, ID: 1.75, IL: 2.45, IN: 1.95, IA: 1.85, KS: 2.05, KY: 2.25, LA: 2.65, ME: 2.15, MD: 2.35,
            MA: 2.75, MI: 2.45, MN: 2.15, MS: 2.35, MO: 2.05, MT: 1.95, NE: 1.85, NV: 2.55, NH: 2.25, NJ: 2.85,
            NM: 2.15, NY: 3.05, NC: 1.95, ND: 1.75, OH: 2.25, OK: 2.15, OR: 2.35, PA: 2.65, RI: 2.95, SC: 2.05,
            SD: 1.85, TN: 2.15, TX: 2.45, UT: 1.85, VT: 2.35, VA: 2.05, WA: 2.55, WV: 2.75, WI: 2.15, WY: 2.05
        }
    };
    
    // State names mapping (without DC)
    window.STATE_NAMES = {
        AL: "Alabama", AK: "Alaska", AZ: "Arizona", AR: "Arkansas", CA: "California",
        CO: "Colorado", CT: "Connecticut", DE: "Delaware", FL: "Florida", GA: "Georgia",
        HI: "Hawaii", ID: "Idaho", IL: "Illinois", IN: "Indiana", IA: "Iowa",
        KS: "Kansas", KY: "Kentucky", LA: "Louisiana", ME: "Maine", MD: "Maryland",
        MA: "Massachusetts", MI: "Michigan", MN: "Minnesota", MS: "Mississippi",
        MO: "Missouri", MT: "Montana", NE: "Nebraska", NV: "Nevada",
        NH: "New Hampshire", NJ: "New Jersey", NM: "New Mexico", NY: "New York",
        NC: "North Carolina", ND: "North Dakota", OH: "Ohio", OK: "Oklahoma",
        OR: "Oregon", PA: "Pennsylvania", RI: "Rhode Island", SC: "South Carolina",
        SD: "South Dakota", TN: "Tennessee", TX: "Texas", UT: "Utah", VT: "Vermont",
        VA: "Virginia", WA: "Washington", WV: "West Virginia", WI: "Wisconsin", WY: "Wyoming"
    };
    
    // Metric configurations
    window.METRIC_CONFIG = {
        glPremiumPct: {
            label: "GL Premium as % of Revenue",
            format: function(data) { return data.range; },
            description: "General Liability insurance premium as a percentage of contractor revenue",
            reverseScale: false
        },
        glSavingsPct: {
            label: "GL Savings as % of Premium",
            format: function(val) { return val + '%'; },
            description: "Potential savings on General Liability insurance premiums",
            reverseScale: false
        },
        glCompetitiveness: {
            label: "GL Carrier Competitiveness",
            format: function(val) { return val + 'th percentile'; },
            description: "Market competitiveness ranking based on number of carrier quotes",
            reverseScale: false
        },
        wcRate: {
            label: "Workers' Comp Rate per $100",
            format: function(val) { return '$' + val.toFixed(2); },
            description: "Workers' Compensation insurance cost per $100 of payroll",
            reverseScale: true
        }
    };
    
    // Application State
    window.currentMetric = 'glPremiumPct';
    window.selectedState = null;
    
    // Color calculation functions
    function getHeatmapColor(value, min, max, reverseScale) {
        if (value == null || min == null || max == null) {
            return 'heat-0';
        }
        
        reverseScale = reverseScale || false;
        
        var normalized = (value - min) / (max - min);
        
        if (reverseScale) {
            normalized = 1 - normalized;
        }
        
        var heatLevel = Math.floor(normalized * 8);
        return 'heat-' + Math.min(7, Math.max(0, heatLevel));
    }
    
    window.updateMapColors = function() {
        var metricData = window.DATA[window.currentMetric];
        var config = window.METRIC_CONFIG[window.currentMetric];
        
        if (!metricData || !config) return;
        
        var values = [];
        for (var state in metricData) {
            if (metricData.hasOwnProperty(state)) {
                var val = window.currentMetric === 'glPremiumPct' ? metricData[state].midpoint : metricData[state];
                values.push(val);
            }
        }
        
        var min = Math.min.apply(Math, values);
        var max = Math.max.apply(Math, values);
        
        for (var state in metricData) {
            if (metricData.hasOwnProperty(state)) {
                var stateElement = document.querySelector('#state-' + state);
                if (stateElement) {
                    for (var i = 0; i <= 7; i++) {
                        stateElement.classList.remove('heat-' + i);
                    }
                    
                    var val = window.currentMetric === 'glPremiumPct' ? metricData[state].midpoint : metricData[state];
                    var colorClass = getHeatmapColor(val, min, max, config.reverseScale);
                    stateElement.classList.add(colorClass);
                }
            }
        }
        
        updateLegend(config);
    };
    
    function updateLegend(config) {
        var legendMin = document.querySelector('.legend-min');
        var legendMax = document.querySelector('.legend-max');
        
        if (!legendMin || !legendMax || !config) return;
        
        if (config.reverseScale) {
            legendMin.textContent = 'Better';
            legendMax.textContent = 'Worse';
        } else {
            legendMin.textContent = 'Low';
            legendMax.textContent = 'High';
        }
    }
    
    window.updateInfoCard = function(stateCode) {
        var stateName = window.STATE_NAMES[stateCode];
        var metricData = stateCode && window.DATA[window.currentMetric] ? window.DATA[window.currentMetric][stateCode] : null;
        var config = window.METRIC_CONFIG[window.currentMetric];
        
        var nameElement = document.querySelector('.info-card .state-name');
        if (nameElement) {
            nameElement.textContent = stateName || 'Select a State';
        }
        
        var valueElement = document.querySelector('.info-card .metric-value');
        if (valueElement) {
            if (metricData && config) {
                var formattedValue = window.currentMetric === 'glPremiumPct' 
                    ? config.format(metricData) 
                    : config.format(metricData);
                valueElement.textContent = formattedValue;
            } else {
                valueElement.textContent = '--';
            }
        }
        
        var descElement = document.querySelector('.info-card .metric-description');
        if (descElement && config) {
            descElement.textContent = stateCode ? config.description : 'Click on a state to view insurance metrics';
        }
        
        var ctaLink = document.querySelector('.info-card .cta-link');
        if (ctaLink) {
            if (stateCode && stateName) {
                ctaLink.href = 'https://app.contractornerd.com/';
                ctaLink.textContent = 'Get Free Quotes for ' + stateName + ' →';
                ctaLink.style.display = 'inline-block';
            } else {
                ctaLink.style.display = 'none';
            }
        }
    };
    
    window.handleMetricToggle = function(metric) {
        var buttons = document.querySelectorAll('.metric-btn');
        for (var i = 0; i < buttons.length; i++) {
            buttons[i].classList.remove('active');
        }
        
        var targetBtn = document.querySelector('[data-metric="' + metric + '"]');
        if (targetBtn) {
            targetBtn.classList.add('active');
        }
        
        window.currentMetric = metric;
        window.updateMapColors();
        
        if (window.selectedState) {
            window.updateInfoCard(window.selectedState);
        }
    };
    
    function populateDropdown() {
        var dropdown = document.getElementById('state-dropdown');
        if (!dropdown) return;
        
        var stateEntries = [];
        for (var code in window.STATE_NAMES) {
            if (window.STATE_NAMES.hasOwnProperty(code)) {
                stateEntries.push([code, window.STATE_NAMES[code]]);
            }
        }
        
        stateEntries.sort(function(a, b) {
            return a[1].localeCompare(b[1]);
        });
        
        for (var i = 0; i < stateEntries.length; i++) {
            var code = stateEntries[i][0];
            var name = stateEntries[i][1];
            var option = document.createElement('option');
            option.value = code;
            option.textContent = name;
            dropdown.appendChild(option);
        }
    }
    
    function initializeToggles() {
        var buttons = document.querySelectorAll('.metric-btn');
        for (var i = 0; i < buttons.length; i++) {
            var btn = buttons[i];
            btn.addEventListener('click', function() {
                window.handleMetricToggle(this.dataset.metric);
            });
        }
    }
    
    function initializeDropdown() {
        var dropdown = document.getElementById('state-dropdown');
        if (dropdown) {
            dropdown.addEventListener('change', function() {
                if (this.value) {
                    window.selectedState = this.value;
                    window.updateInfoCard(this.value);
                }
            });
        }
    }
    
    window.showTooltip = function(event, stateCode) {
        var tooltip = document.getElementById('map-tooltip');
        var metricData = window.DATA[window.currentMetric] && window.DATA[window.currentMetric][stateCode] ? window.DATA[window.currentMetric][stateCode] : null;
        var config = window.METRIC_CONFIG[window.currentMetric];
        
        if (metricData && tooltip && config) {
            var formattedValue = window.currentMetric === 'glPremiumPct' 
                ? config.format(metricData) 
                : config.format(metricData);
            
            var stateNameEl = tooltip.querySelector('.state-name');
            var metricLabelEl = tooltip.querySelector('.metric-label');
            var metricValueEl = tooltip.querySelector('.metric-value');
            
            if (stateNameEl) stateNameEl.textContent = window.STATE_NAMES[stateCode] || '';
            if (metricLabelEl) metricLabelEl.textContent = config.label || '';
            if (metricValueEl) metricValueEl.textContent = formattedValue || '';
            
            var rect = event.target.getBoundingClientRect();
            var mapWrapper = document.querySelector('.map-wrapper');
            if (!mapWrapper) return;
            
            var wrapperRect = mapWrapper.getBoundingClientRect();
            
            var left = rect.right - wrapperRect.left + 10;
            var top = rect.top - wrapperRect.top + (rect.height / 2) - 40;
            
            var tooltipWidth = 220;
            if (left + tooltipWidth > wrapperRect.width) {
                left = rect.left - wrapperRect.left - tooltipWidth - 10;
            }
            if (top < 10) top = 10;
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.style.display = 'block';
        }
    };
    
    window.hideTooltip = function() {
        var tooltip = document.getElementById('map-tooltip');
        if (tooltip) {
            tooltip.style.display = 'none';
        }
    };
    
    window.handleStateClick = function(stateCode) {
        var state = document.getElementById('state-' + stateCode);
        if (!state) return;
        
        var isAlreadySelected = state.classList.contains('selected');
        
        var allStates = document.querySelectorAll('.state-path');
        for (var i = 0; i < allStates.length; i++) {
            allStates[i].classList.remove('selected');
        }
        
        if (isAlreadySelected) {
            window.selectedState = null;
            window.updateInfoCard(null);
        } else {
            state.classList.add('selected');
            window.selectedState = stateCode;
            window.updateInfoCard(stateCode);
        }
        
        window.hideTooltip();
    };
    
    window.handleStateHover = function(event, stateCode) {
        if (window.innerWidth > 768) {
            window.showTooltip(event, stateCode);
        }
    };
    
    window.handleStateLeave = function() {
        window.hideTooltip();
    };
    
    function initializeStateInteractions() {
        var states = document.querySelectorAll('.state-path');
        
        for (var i = 0; i < states.length; i++) {
            var state = states[i];
            var stateCode = state.id.replace('state-', '');
            
            state.addEventListener('click', function(code) {
                return function() {
                    window.handleStateClick(code);
                };
            }(stateCode));
            
            state.addEventListener('mouseover', function(code) {
                return function(e) {
                    window.handleStateHover(e, code);
                };
            }(stateCode));
            
            state.addEventListener('mouseout', function() {
                window.handleStateLeave();
            });
            
            state.style.cursor = 'pointer';
            state.style.pointerEvents = 'all';
        }
    }
    
    function initializeMap() {
        if (window.mapInitialized) return;
        window.mapInitialized = true;
        
        initializeStateInteractions();
        window.updateMapColors();
        populateDropdown();
        initializeToggles();
        initializeDropdown();
        window.updateInfoCard(null);
    }
    
    var root = document.getElementById('insurance-map-container');
    if (!root) return;
    
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        initializeMap();
    } else {
        document.addEventListener('DOMContentLoaded', initializeMap);
    }
    window.addEventListener('load', initializeMap);
})();
</script>